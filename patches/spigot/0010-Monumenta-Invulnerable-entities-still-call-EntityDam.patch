From 049910469d6cc540a313e3904def755c37932896 Mon Sep 17 00:00:00 2001
From: Monumenta <monumenta.mgmt@gmail.com>
Date: Sun, 14 Jan 2018 20:41:40 -0500
Subject: [PATCH 10/10] Monumenta - Invulnerable entities still call
 EntityDamageByEntityEvent

---
 src/main/java/net/minecraft/server/EntityLiving.java | 17 ++++++++++++++++-
 1 file changed, 16 insertions(+), 1 deletion(-)

diff --git a/src/main/java/net/minecraft/server/EntityLiving.java b/src/main/java/net/minecraft/server/EntityLiving.java
index ee2d1f9a..555f3e79 100644
--- a/src/main/java/net/minecraft/server/EntityLiving.java
+++ b/src/main/java/net/minecraft/server/EntityLiving.java
@@ -31,6 +31,12 @@ import org.bukkit.event.entity.EntityTeleportEvent;
 import org.bukkit.event.player.PlayerItemConsumeEvent;
 // CraftBukkit end
 
+// Monumenta start
+import java.util.EnumMap;
+import org.bukkit.event.entity.EntityDamageByEntityEvent;
+import org.bukkit.event.entity.EntityDamageEvent.DamageCause;
+// Monumenta end
+
 import org.bukkit.craftbukkit.SpigotTimings; // Spigot
 
 public abstract class EntityLiving extends Entity {
@@ -812,6 +818,7 @@ public abstract class EntityLiving extends Entity {
 
     public boolean damageEntity(DamageSource damagesource, float f) {
         if (this.isInvulnerable(damagesource)) {
+            damageEntity0(damagesource, f);
             return false;
         } else if (this.world.isClientSide) {
             return false;
@@ -1275,7 +1282,15 @@ public abstract class EntityLiving extends Entity {
 
     // CraftBukkit start
     protected boolean damageEntity0(final DamageSource damagesource, float f) { // void -> boolean, add final
-       if (!this.isInvulnerable(damagesource)) {
+       if (this.isInvulnerable(damagesource)) {
+            EntityDamageByEntityEvent event = new EntityDamageByEntityEvent(this.getBukkitEntity(),
+                    damagesource.getEntity().getBukkitEntity(),
+                    DamageCause.CUSTOM,
+                    new EnumMap<DamageModifier, Double>(DamageModifier.class),
+                    new EnumMap<DamageModifier, Function<? super Double, Double>>(DamageModifier.class));
+
+            this.world.getServer().getPluginManager().callEvent(event);
+       } else {
             final boolean human = this instanceof EntityHuman;
             float originalDamage = f;
             Function<Double, Double> hardHat = new Function<Double, Double>() {
-- 
2.14.1

