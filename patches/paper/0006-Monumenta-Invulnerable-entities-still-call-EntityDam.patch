From b35dae805d60c32f0b1d0f0bec70be07d6197619 Mon Sep 17 00:00:00 2001
From: Monumenta <monumenta.mgmt@gmail.com>
Date: Sun, 14 Jan 2018 20:41:40 -0500
Subject: [PATCH 06/11] Monumenta - Invulnerable entities still call
 EntityDamageByEntityEvent

---
 .../net/minecraft/server/EntityLiving.java    | 19 ++++++++++++++++++-
 .../net/minecraft/server/EntityParrot.java    | 11 +----------
 .../craftbukkit/event/CraftEventFactory.java  |  2 +-
 3 files changed, 20 insertions(+), 12 deletions(-)

diff --git a/src/main/java/net/minecraft/server/EntityLiving.java b/src/main/java/net/minecraft/server/EntityLiving.java
index 4acbc17a..fb5b671b 100644
--- a/src/main/java/net/minecraft/server/EntityLiving.java
+++ b/src/main/java/net/minecraft/server/EntityLiving.java
@@ -37,6 +37,10 @@ import org.bukkit.event.entity.EntityTeleportEvent;
 import org.bukkit.event.player.PlayerItemConsumeEvent;
 // CraftBukkit end
 
+import java.util.EnumMap;
+import com.google.common.base.Functions;
+import org.bukkit.event.entity.EntityDamageEvent.DamageCause;
+
 import co.aikar.timings.MinecraftTimings; // Paper
 
 public abstract class EntityLiving extends Entity {
@@ -936,6 +940,7 @@ public abstract class EntityLiving extends Entity {
 
     public boolean damageEntity(DamageSource damagesource, float f) {
         if (this.isInvulnerable(damagesource)) {
+            damageEntity0(damagesource, f);
             return false;
         } else if (this.world.isClientSide) {
             return false;
@@ -1449,9 +1454,21 @@ public abstract class EntityLiving extends Entity {
         }
     }
 
+    private static final Function<? super Double, Double> ZERO = Functions.constant(-0.0);
+
+
     // CraftBukkit start
     protected boolean damageEntity0(final DamageSource damagesource, float f) { // void -> boolean, add final
-       if (!this.isInvulnerable(damagesource)) {
+       if (this.isInvulnerable(damagesource)) {
+            if (damagesource != null) {
+                Map<DamageModifier, Double> modifiers = new EnumMap<DamageModifier, Double>(DamageModifier.class);
+                Map<DamageModifier, Function<? super Double, Double>> modifierFunctions = new EnumMap<DamageModifier, Function<? super Double, Double>>(DamageModifier.class);
+                modifiers.put(DamageModifier.BASE, (double)f);
+                modifierFunctions.put(DamageModifier.BASE, ZERO);
+
+                CraftEventFactory.callEntityDamageEvent(damagesource.getEntity(), this, DamageCause.ENTITY_ATTACK, modifiers, modifierFunctions);
+            }
+       } else {
             final boolean human = this instanceof EntityHuman;
             float originalDamage = f;
             Function<Double, Double> hardHat = new Function<Double, Double>() {
diff --git a/src/main/java/net/minecraft/server/EntityParrot.java b/src/main/java/net/minecraft/server/EntityParrot.java
index 6acad352..6618bf94 100644
--- a/src/main/java/net/minecraft/server/EntityParrot.java
+++ b/src/main/java/net/minecraft/server/EntityParrot.java
@@ -300,16 +300,7 @@ public class EntityParrot extends EntityPerchable implements EntityBird {
     }
 
     public boolean damageEntity(DamageSource damagesource, float f) {
-        if (this.isInvulnerable(damagesource)) {
-            return false;
-        } else {
-            if (this.goalSit != null) {
-                // CraftBukkit - moved into EntityLiving.d(DamageSource, float)
-                // this.goalSit.setSitting(false);
-            }
-
-            return super.damageEntity(damagesource, f);
-        }
+        return super.damageEntity(damagesource, f);
     }
 
     public int getVariant() {
diff --git a/src/main/java/org/bukkit/craftbukkit/event/CraftEventFactory.java b/src/main/java/org/bukkit/craftbukkit/event/CraftEventFactory.java
index 2e0b4de8..3330e77e 100644
--- a/src/main/java/org/bukkit/craftbukkit/event/CraftEventFactory.java
+++ b/src/main/java/org/bukkit/craftbukkit/event/CraftEventFactory.java
@@ -690,7 +690,7 @@ public class CraftEventFactory {
         return event;
     }
 
-    private static EntityDamageEvent handleEntityDamageEvent(Entity entity, DamageSource source, Map<DamageModifier, Double> modifiers, Map<DamageModifier, Function<? super Double, Double>> modifierFunctions) {
+    public static EntityDamageEvent handleEntityDamageEvent(Entity entity, DamageSource source, Map<DamageModifier, Double> modifiers, Map<DamageModifier, Function<? super Double, Double>> modifierFunctions) {
         if (source.isExplosion()) {
             DamageCause damageCause;
             Entity damager = entityDamage;
-- 
2.17.1

